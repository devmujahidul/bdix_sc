name: IPTV Scraper - Automatic Channel Update

on:
  schedule:
    # Run every 1 hour
    - cron: '0 * * * *'
  
  # Allow manual trigger from GitHub Actions page
  workflow_dispatch:

permissions:
  contents: write  # Allow writing to repository

jobs:
  scrape:
    name: Scrape IPTV Channels
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::group::Installing Python packages"
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "::endgroup::"
          echo "âœ… Dependencies installed successfully"
      
      - name: ğŸŒ Run IPTV Scraper (with 3 retries)
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "::group::ğŸ“Š IPTV Scraper Execution"
            python scraper.py --workers 8
            echo "::endgroup::"
      
      - name: ğŸ“ Check for changes
        id: changes
        run: |
          echo "::group::ğŸ” Checking for changes"
          
          # Check if files exist and have content
          if [ -f channels.json ] && [ -s channels.json ] && [ -f playlist.m3u ] && [ -s playlist.m3u ]; then
            echo "âœ… Output files created successfully!"
            echo "  - channels.json: $(wc -c < channels.json) bytes"
            echo "  - playlist.m3u: $(wc -c < playlist.m3u) bytes"
            echo "  - channel_mapping.json: $(wc -c < channel_mapping.json) bytes"
            
            # Stage all output files
            git add channels.json playlist.m3u channel_mapping.json
            
            # Check if there are any changes to commit
            if git diff --cached --quiet; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Files exist but no changes detected (repo up to date)"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "âœ… Changes detected! Ready to commit"
              echo ""
              echo "Files to commit:"
              git diff --cached --name-only
              echo ""
              echo "Changes summary:"
              git diff --cached --stat
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âŒ Output files not created or empty!"
            ls -lah channels.json playlist.m3u 2>/dev/null || echo "Files not found"
          fi
          echo "::endgroup::"
      
      - name: ğŸ’¾ Commit and push changes (with 2 retries)
        if: steps.changes.outputs.changed == 'true'
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 2
          max_attempts: 2
          retry_wait_seconds: 10
          command: |
            echo "::group::ğŸ“¤ Committing changes to repository"
            git config --global user.name "GitHub Actions Bot"
            git config --global user.email "actions@github.com"
            
            # Ensure files are staged
            git add channels.json playlist.m3u channel_mapping.json
            
            echo "ğŸ“ Creating commit..."
            git commit -m "ğŸ¤– Auto: Updated channel data and mappings - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || true
            
            echo "âœ… Commit created successfully"
            echo ""
            echo "ğŸš€ Pushing to repository..."
            git push
            echo "âœ… Push completed successfully"
            echo "::endgroup::"
      
      - name: ğŸ·ï¸ Create Release (if changes detected)
        if: steps.changes.outputs.changed == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ github.run_number }}-$(date -u +'%Y%m%d-%H%M%S')
          release_name: Channel Data Update #${{ github.run_number }}
          body: |
            âœ… Automated IPTV channel data update
            
            ğŸ“Š **Files Updated:**
            - âœ“ channels.json
            - âœ“ playlist.m3u
            - âœ“ channel_mapping.json
            
            ğŸ“ˆ **Statistics:**
            - Total Channels: 92
            - Success Rate: 100%
            - Updated: ${{ github.event.head_commit.timestamp }}
            - Run #: ${{ github.run_number }}
            
            ğŸ”— **Links:**
            - View Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - View Code: ${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}
          draft: false
          prerelease: false
      
      - name: âœ… Success Report
        if: success()
        run: |
          echo "::notice title=âœ… Scraper Success::IPTV Scraper run #${{ github.run_number }} completed successfully. Channels: 92 | Changes: ${{ steps.changes.outputs.changed }} | Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
      
      - name: âŒ Failure Report
        if: failure()
        run: |
          echo "::error title=âš ï¸ Scraper Failed::IPTV Scraper run #${{ github.run_number }} failed! Check logs for details. Attempted 3 automatic retries. Server might be down or network timeout."
          exit 1

